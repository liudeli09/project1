<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="referrer" content="no-referrer">
		<title></title>
		<link rel="stylesheet" href="css/public.css"/>
		<link rel="stylesheet" href="css/boli.css"/>
		<link rel="stylesheet" href="css/index-footer.css"/>
		<link rel="stylesheet" href="css/details.css"/>
	</head>
	<body>
		<section id="header"></section>
		
		<section id="detail" class="clear">
			<div class="margin">
				<article class="big clear">
					
				</article>
				<aside>
					<div class="mess">
						<h3>商家信息</h3>
						<img src="imgs/ba.png" />
						<span>张海***66</span>
						<p>查看商家所有商品</p>
					</div>
					<ul>
						<p>同类爆款</p>
						<li>
							<img src="http://img1.vboly.com/2019/10/12/412034765590000302.jpg_187_187.jpg" />
							<a href="#">【限时免费】20g 儿童四季鼻炎膏</a>
						</li>
						<li>
							<img src="http://img1.vboly.com/2019/11/12/463638034822000674.gif_187_187.gif" />
							<a href="#">【限时免费】汽车载孙露cd唱片</a>
						</li>
						<li>
							<img src="http://img1.vboly.com/2019/10/17/421121454339000250.jpg_187_187.jpg" />
							<a href="#">【限时抢购】5双 春秋冬运动中筒</a>
						</li>
						<li>
							<img src="http://img1.vboly.com/2019/10/09/416207813357000180.jpg_187_187.jpg" />
							<a href="#">【限时免费】10ml 耳舒保健液</a>
						</li>
						<li>
							<img src="http://img1.vboly.com/2019/11/01/446668714678000738.jpg_187_187.jpg" />
							<a href="#">【京东搜索下单】墙纸壁纸自粘</a>
						</li>
					</ul>
				</aside>
				<div class="water">
					<ul class="clear">
						<li class="te">抢购流程</li>
						<li>1、点击 <a href="#">我要抢购</a></li>
						<li>2、按 <a href="#">直接下单</a> 方式</li>
						<li>3、返回微薄利</li>
						<li>4、商家审核订单</li>
					</ul>
				</div>
				<div class="how">
					<ul>
						<li><a href="#">如何抢购</a></li>
						<li><a href="#">如何晒单</a></li>
						<li><a href="#">如何领回优惠金</a></li>
					</ul>
				</div>
				<div class="fast">
					<h3><s>温馨提示</s></h3>
					<div class="tip">
						<p><i>默认快递：</i>申通 中国邮政，不到的请勿下单！</p>
						<p><i>温馨提示：</i></p>
						<p>请不要使用淘宝客（返利网）、淘金币、店铺优惠券、分期付款、红包下单！否则将按照违规处理！</p>
						<p><i>请务必按照微薄利提供的下单流程下单；如不按流程下单将按违规处理！</i></p>
						<p>尺寸或规格：5双</p>
						<p>如有运费请联系店铺客服修改包邮</p>
						<p>不参与店铺活动</p>
						<a href="#">点击查看买家必读》》》</a>
					</div>
				</div>
			</div>
		</section>
		<section id="footer"></section>
	</body>
	
	<script src="js/jquery.js"></script>
	<script src="js/ajax.js"></script>
	<script src="js/cookie.js"></script>
	
	<script>
		$("#header").load("http://localhost/weiboli/html-public/header.html");
		$("#footer").load("http://localhost/weiboli/html-public/footer.html");
	</script>
	
	<!-- details -->
	<script> 
		class Detail{
        constructor(options){
            this.url = options.url;
            this.tbody = options.tbody;
            
            // 1.读取到所有商品数据
            this.load();
			
            // 5.事件委托绑定事件
            this.addEvent();
			
			//放大镜
			
        }
		
        load(){
            var that = this;
            ajaxGet(this.url,function(res){
                that.res = JSON.parse(res);
                // 2.读取到cookie
                that.getCookie();
            })
        }
        getCookie(){
            this.goods = getCookie("goods") ? JSON.parse(getCookie("goods")) : [];
            // 3.拿到cookie中的id与所有商品数据的id做比较
            this.display();
			console.log(this.goods)
        }
        display(){
            var str = "";
            for(var i=0;i<this.res.length;i++){
				for(var j=0;j<this.goods.length;j++){
                    if(this.res[i].id == this.goods[this.goods.length-1].id){
                        // 4.相同了，渲染这个数据（就是添加到购物车的商品）
                        str += `<h3>${this.res[i].name}</h3>
		<div class="goods-main">
			<div class="goods-l">
				<div id = "wrap">
					<img src="${this.res[i].img.img2}" />
					<img src="${this.res[i].img.img1}" />
					<div class="box"></div>
				</div>
				<div id="bigArea">
					<img class="da" src = "${this.res[i].img.img2}"/>
					<img src = "${this.res[i].img.img1}"/>
				</div>
				<ul>
					<li class="act" ><img src="${this.res[i].img.img2}"/></li>
					<li><img src="${this.res[i].img.img1}"/></li>
				</ul>
			</div>
			<div class="goods-r">
				<h4>${this.res[i].name}</h4>
				<ul class="clear">
					<li>
						<p>限量份数</p>
						<p>${this.res[i].introduce.number}</p>
					</li>
					<li>
						<p>剩余份数</p>
						<p>${this.res[i].introduce.Surplus}</p>
					</li>
					<li>
						<p>剩余时间</p>
						<p class="te">${this.res[i].introduce.time}</p>
					</li>
				</ul>
				<p class="bao">商家已存入担保金 <i>136.50</i> 元请您放心购买！</p>
				<div class="last clear" carindex="${this.res[i].id}">
					<p class="p">折后价:<s>${this.res[i].price}</s><a href="car.html" class="buy">我要抢购</a></p>
					<span>下单价： <i>${this.res[i].price}</i> 元</span>
					<span>优惠金额： <i>${this.res[i].introduce.discount1}</i> 元</span>
					<span>折扣： <i>${this.res[i].introduce.discount2}</i> 折</span>
				</div>
			</div>
		</div>
		`;
		break;
                    }
                }
            }
            this.tbody.innerHTML = str;
			
			this.card();
			this.da =document.querySelector(".da");
			console.log(this.da);
			this.mirror();
        }
		
        addEvent(){
            var that = this;
            this.tbody.onclick = function(eve){
                if(eve.target.className == "buy"){
                    // 5.记录id
                    that.id = eve.target.parentNode.parentNode.getAttribute("carindex");
					console.log(that.id);
                    // 6.准备存cookie
                    that.setCookie();
                }
            }
        }
		
		//存购物车的getCookie
		
		setCookie(){
		    this.cars = getCookie("cars") ? JSON.parse(getCookie("cars")) : [];
		    if(this.cars.length == 0){
		        this.cars.push({
		            id:this.id,
		            num:1
		        })
		    }else{
		        // 7-3.不为空：不是第一次加入购物车：
		        var onoff = true;   //用来记录是否是新商品的状态
		        for(var i=0;i<this.cars.length;i++){
		            // 7-4.判断当前商品，新还是旧
		            if(this.cars[i].id === this.id){
		                // 7-5.旧：修改数据,同时修改是否是新商品的状态
		                this.cars[i].num++;
		                onoff = false;
		            }
		        }
		        if(onoff){
		            this.cars.push({
		                id:this.id,
		                num:1
		            })
		        }
		    }
		    // 8.数组的操作结束后，一定要再存回cookie
		    setCookie("cars",JSON.stringify(this.cars));
		}
		
		//放大镜
		mirror(){
			var wrap = document.getElementById("wrap");
			var box = document.querySelector(".box");
			var bigArea = document.getElementById("bigArea");
			//var da =document.querySelector(".da");
			console.log(bigArea);

			var that = this;
			wrap.onmouseenter = function() {
				box.style.display = "block";
				bigArea.style.display = "block";
				var r = (wrap.clientWidth - box.clientWidth) / (800 - bigArea.clientWidth);
				// 绑定mousemove事件
				var _this = that;
				document.onmousemove = function(e) {
					// 计算鼠标在页面中的距离
					var mouseX =  e.pageX;
					var mouseY = e.pageY;
					// 计算元素在视口中的距离
					var elementX = offset(wrap).left;
					var elementY = offset(wrap).top;
					// 计算鼠标在元素中的距离
					var resultX = mouseX - elementX - wrap.clientLeft - box.clientWidth / 2;
					var resultY = mouseY - elementY - wrap.clientTop - box.clientHeight / 2;
					if (resultX < 0) {
						resultX = 0;
					} else if (resultX > wrap.clientWidth - box.clientWidth) {
						resultX = wrap.clientWidth - box.clientWidth;
					}
		
					if (resultY < 0) {
						resultY = 0;
					} else if (resultY > wrap.clientHeight - box.clientHeight) {
						resultY = wrap.clientHeight - box.clientHeight;
					}
					box.style.left = resultX + "px";
					box.style.top = resultY + "px";
					//bigArea.style.backgroundPositionX = -resultX / r + "px";
					//bigArea.style.backgroundPositionY = -resultY / r + "px";
					console.log(_this.da);
					_this.da.style.left = -resultX / r + "px";
					
					_this.da.style.top = -resultY / r + "px";
					
					
				}
			}
			wrap.onmouseleave = function() {
				box.style.display = "none";
				bigArea.style.display = "none";
			}
			
			
			function offset(dom) {
				// 返回一个对象
				var obj = {
					left: 0,
					top: 0
				}
			
				// 先让这个对象加上 dom的自己得到定位父元素的距离
				obj.left = dom.offsetLeft;
				obj.top = dom.offsetTop;
				// 判定浏览器是否是IE8 
				var isIE8 = window.navigator.userAgent.indexOf("MSIE 8") != -1;
			
			
				// 循环往上走 累加每一个offsetParent的offsetLeft和clientLeft 
				// 加每一个offsetParent的offsetTop和clientTop
				var offsetParent = dom.offsetParent;
				while (offsetParent != document.body) {
					if (isIE8) {
						obj.left += offsetParent.offsetLeft;
						obj.top += offsetParent.offsetTop;
					} else {
						obj.left += offsetParent.offsetLeft + offsetParent.clientLeft;
						obj.top += offsetParent.offsetTop + offsetParent.clientTop;
					}
					offsetParent = offsetParent.offsetParent;
				}
				return obj;
			}
				
		}
		
		card(){
			var that = this;
			$(".goods-l").children("ul").children("li").click(function(){
				//这里的this就是点击的当前元素 相当于e
				$(this).addClass("act").siblings().removeClass("act");
				$("#bigArea").children("img").eq($(this).index()).addClass("da").siblings().removeClass("da");
				console.log(that.da);
				that.da = document.querySelector(".da");
				console.log(that.da);
				$("#wrap").children("img").css("display","none").eq($(this).index()).css("display","block");
				console.log($(this).index());
			})
		}

    }

    new Detail({
        url:"http://localhost/weiboli/json/goods.json",
        tbody:document.querySelector("article")
    })
	
	
	
	</script>


	
</html>
